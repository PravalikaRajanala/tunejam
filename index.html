<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuneJam - Collaborative Audio Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <!-- Removed Firebase SDK imports -->
    
    <style>
        /* Custom styles to enhance Tailwind's default behavior and provide specific overrides */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            gap: 20px; /* Space between player and playlist */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                padding: 10px;
            }
            .player-section, .playlist-section {
                width: 100%;
                max-width: none;
            }
        }
        .player-section, .playlist-section {
            background-color: #ffffff; /* White background for sections */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 1.5rem;
            max-width: 450px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .player-section {
            align-items: center;
            text-align: center;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background-color: #4f46e5; /* Blue */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); /* Focus ring effect */
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background-color: #4f46e5; /* Blue */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        input[type="range"]:hover::-webkit-slider-thumb {
            background-color: #4338ca; /* Darker blue on hover */
        }
        input[type="range"]:hover::-moz-range-thumb {
            background-color: #4338ca;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #e5e7eb; /* Light gray track */
            border-radius: 3px;
        }
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }
        /* Custom modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-50px);
            opacity: 0;
            animation: modal-fade-in 0.3s forwards ease-out;
        }
        .modal.hidden .modal-content {
            animation: modal-fade-out 0.3s forwards ease-in;
        }
        @keyframes modal-fade-in {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes modal-fade-out {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-50px); opacity: 0; }
        }

        /* Loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Custom Message Box */
        #custom-message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #custom-message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen flex items-center justify-center p-4">

    <!-- Main Player Section -->
    <div class="player-section">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">TuneJam</h1>
        <div class="w-48 h-48 bg-gray-200 rounded-lg shadow-md flex items-center justify-center overflow-hidden mb-4">
            <img id="song-thumbnail" src="https://placehold.co/128x128/CCCCCC/FFFFFF?text=No+Track" alt="Song Thumbnail" class="w-full h-full object-cover">
            <div id="youtube-player" class="hidden"></div> <!-- YouTube player element -->
        </div>
        <h2 id="song-title" class="text-xl font-semibold text-gray-900 dark:text-white truncate w-full px-2">No song selected</h2>
        <p id="song-artist" class="text-md text-gray-600 dark:text-gray-400 mb-4 truncate w-full px-2"></p>

        <!-- Local Audio Player Controls (visible by default) -->
        <div id="local-player-controls" class="w-full flex flex-col gap-3">
            <div class="flex items-center justify-between w-full">
                <span id="current-time" class="text-sm text-gray-600 dark:text-gray-400">0:00</span>
                <input type="range" id="progress-bar" value="0" min="0" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mx-2">
                <span id="duration" class="text-sm text-gray-600 dark:text-gray-400">0:00</span>
            </div>
            <div class="flex items-center justify-center space-x-4">
                <button id="prev-btn" class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 transition-colors duration-200 shadow-md">
                    <i class="fas fa-backward"></i>
                </button>
                <button id="play-pause-btn" class="p-4 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200 shadow-lg transform hover:scale-105">
                    <i id="play-pause-icon" class="fas fa-play text-xl"></i>
                </button>
                <button id="next-btn" class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 transition-colors duration-200 shadow-md">
                    <i class="fas fa-forward"></i>
                </button>
            </div>
            <div class="flex items-center space-x-2 w-full">
                <i class="fas fa-volume-down text-gray-600 dark:text-gray-400"></i>
                <input type="range" id="volume-slider" value="100" min="0" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <i class="fas fa-volume-up text-gray-600 dark:text-gray-400"></i>
            </div>
        </div>

        <!-- YouTube Player Controls (hidden by default) -->
        <div id="youtube-player-controls" class="w-full flex-col gap-3 hidden">
            <div class="flex items-center justify-between w-full">
                <span id="youtube-current-time" class="text-sm text-gray-600 dark:text-gray-400">0:00</span>
                <input type="range" id="youtube-progress-bar" value="0" min="0" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mx-2">
                <span id="youtube-duration" class="text-sm text-gray-600 dark:text-gray-400">0:00</span>
            </div>
            <div class="flex items-center justify-center space-x-4">
                <button id="youtube-prev-btn" class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 transition-colors duration-200 shadow-md">
                    <i class="fas fa-backward"></i>
                </button>
                <button id="youtube-play-pause-btn" class="p-4 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200 shadow-lg transform hover:scale-105">
                    <i id="youtube-play-pause-icon" class="fas fa-play text-xl"></i>
                </button>
                <button id="youtube-next-btn" class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 transition-colors duration-200 shadow-md">
                    <i class="fas fa-forward"></i>
                </button>
            </div>
            <div class="flex items-center space-x-2 w-full">
                <i class="fas fa-volume-down text-gray-600 dark:text-gray-400"></i>
                <input type="range" id="youtube-volume-slider" value="100" min="0" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <i class="fas fa-volume-up text-gray-600 dark:text-gray-400"></i>
            </div>
        </div>


        <!-- Jam Session Controls -->
        <div id="jam-controls" class="w-full bg-blue-50 p-4 rounded-lg shadow-inner hidden">
            <h3 class="text-lg font-bold text-blue-800 mb-2">Current Jam: <span id="jam-name-display"></span></h3>
            <p id="jam-id-display" class="text-sm text-blue-700 mb-3 truncate">Jam ID: Loading...</p>
            <div class="flex flex-col space-y-2">
                <button id="share-jam-link-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    <i class="fas fa-share-alt mr-2"></i>Share Jam Link
                </button>
                <button id="copy-jam-id-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    <i class="fas fa-copy mr-2"></i>Copy Jam ID
                </button>
                <button id="leave-jam-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200">
                    <i class="fas fa-sign-out-alt mr-2"></i>Leave Jam
                </button>
            </div>
            <div class="mt-4">
                <h4 id="participants-count" class="text-md font-semibold text-blue-800 mb-2">Participants (0):</h4>
                <ul id="participants-list" class="text-sm text-blue-700 max-h-24 overflow-y-auto custom-scrollbar">
                    <!-- Participants will be listed here -->
                </ul>
            </div>
            <!-- Host Permissions Management Section -->
            <div id="permissions-management" class="mt-4 hidden">
                <h4 class="text-md font-semibold text-blue-800 mb-2">Manage Permissions:</h4>
                <div id="permissions-list" class="space-y-2">
                    <!-- Participant permissions will be dynamically rendered here by host -->
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="w-full flex flex-col space-y-3 mt-4">
            <button id="search-button" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 transform hover:-translate-y-1 shadow-md">
                <i class="fas fa-search mr-2"></i>Search & Add Songs
            </button>
            <button id="play-random-hosted-songs-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition duration-300 transform hover:-translate-y-1 shadow-md">
                <i class="fas fa-random mr-2"></i>Play Random Hosted MP3s
            </button>
            <div class="relative inline-block text-left w-full">
                <button id="create-jam-session-dropdown-btn" type="button" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 transform hover:-translate-y-1 shadow-md focus:outline-none" aria-haspopup="true" aria-expanded="true">
                    <i class="fas fa-plus-circle mr-2"></i>Create Jam Session
                </button>
            </div>
            <div class="relative inline-block text-left w-full">
                <button id="join-jam-session-dropdown-btn" type="button" class="w-full bg-gray-700 text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition duration-300 transform hover:-translate-y-1 shadow-md focus:outline-none" aria-haspopup="true" aria-expanded="true">
                    <i class="fas fa-users mr-2"></i>Join Jam Session
                </button>
            </div>
        </div>
    </div>

    <!-- Playlist Section -->
    <div class="playlist-section">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Current Playlist</h3>
        <ul id="playlist-container" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
            <!-- Playlist items will be dynamically inserted here -->
        </ul>
    </div>

    <!-- Modals (Hidden by default) -->

    <!-- Search Modal -->
    <div id="search-modal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Search Songs</h3>
                <button id="close-search-modal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <input type="text" id="search-input" placeholder="Search by title or artist..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Hosted MP3s</h4>
            <div id="search-results" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar border rounded-lg p-2 mb-4">
                <!-- Search results for hosted MP3s will be loaded here -->
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-2">YouTube Videos</h4>
            <div id="youtube-search-results-modal" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar border rounded-lg p-2">
                <!-- Search results for YouTube will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Song Confirmation Modal -->
    <div id="add-song-modal" class="modal hidden">
        <div class="modal-content text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Add Song to Playlist?</h3>
                <button id="close-add-song-modal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <img id="add-song-thumbnail" src="https://placehold.co/128x128/CCCCCC/FFFFFF?text=Song" alt="Song Thumbnail" class="w-24 h-24 rounded-md object-cover mx-auto mb-4 shadow-md">
            <h4 id="add-song-title" class="text-lg font-semibold text-gray-900 mb-1 truncate">Song Title</h4>
            <p id="add-song-artist" class="text-md text-gray-600 mb-4 truncate">Artist Name</p>
            <button id="confirm-add-song-btn" class="bg-blue-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                Confirm Add
            </button>
        </div>
    </div>

    <!-- Create Jam Session Modal -->
    <div id="create-jam-modal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Create New Jam Session</h3>
                <button id="close-create-jam-modal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <div class="mb-4">
                <label for="create-jam-name-input" class="block text-gray-700 text-sm font-medium mb-2">Jam Session Name</label>
                <input type="text" id="create-jam-name-input" placeholder="e.g., Chill Vibes" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="mb-4">
                <label for="create-jam-nickname-input" class="block text-gray-700 text-sm font-medium mb-2">Your Nickname</label>
                <input type="text" id="create-jam-nickname-input" placeholder="e.g., DJ Groove" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <button id="create-jam-button" class="bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-200 w-full">
                Create Jam
            </button>
            <div id="share-link-container" class="mt-6 p-3 bg-gray-100 border border-gray-200 rounded-lg hidden">
                <p class="text-sm font-medium text-gray-700 mb-2">Share this link to invite others:</p>
                <div class="flex items-center space-x-2">
                    <input type="text" id="jam-share-link" readonly
                           class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-md text-sm text-gray-700 truncate">
                    <button id="copy-share-link-button" class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors duration-200">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Jam Session Modal -->
    <div id="join-jam-modal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Join Existing Jam Session</h3>
                <button id="close-join-jam-modal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <p id="join-jam-name-display" class="text-lg text-center text-indigo-600 font-semibold mb-4"></p>
            <div class="mb-4">
                <label for="join-jam-id-input" class="block text-gray-700 text-sm font-medium mb-2">Jam ID</label>
                <input type="text" id="join-jam-id-input" placeholder="Enter Jam ID" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="mb-4">
                <label for="join-jam-nickname-input" class="block text-gray-700 text-sm font-medium mb-2">Your Nickname</label>
                <input type="text" id="join-jam-nickname-input" placeholder="e.g., Music Lover" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <button id="join-jam-button" class="bg-gray-700 text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition duration-200 w-full">
                Join Jam
            </button>
        </div>
    </div>

    <!-- Global Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg font-semibold mb-4"></p>
            <button id="modal-ok-button" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                OK
            </button>
        </div>
    </div>

    <script type="module">
        // Removed Firebase SDK imports and initializations.

        // Global variables
        let jamId = null;
        let socket = null; // Socket.IO instance
        let currentJamHostSid = null; // Store the host SID from socket.io
        let currentJamName = ''; // Store the name of the current jam
        let myPermissions = { play: false, add: false, remove: false }; // Current client's permissions
        let jamSessionParticipants = {}; // Object of {sid: {nickname: '...', permissions: {}}}

        // Elements
        const audioPlayer = new Audio();
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeSpan = document.getElementById('current-time');
        const durationSpan = document.getElementById('duration');
        const songTitleSpan = document.getElementById('song-title');
        const songArtistSpan = document.getElementById('song-artist');
        const songThumbnailImg = document.getElementById('song-thumbnail');
        const youtubePlayerDiv = document.getElementById('youtube-player');
        const localPlayerControls = document.getElementById('local-player-controls');
        const youtubePlayerControls = document.getElementById('youtube-player-controls');
        const youtubeProgressBar = document.getElementById('youtube-progress-bar');
        const youtubeCurrentTimeSpan = document.getElementById('youtube-current-time');
        const youtubeDurationSpan = document.getElementById('youtube-duration');
        const youtubeVolumeSlider = document.getElementById('youtube-volume-slider');
        const youtubePlayPauseBtn = document.getElementById('youtube-play-pause-btn');
        const youtubePlayPauseIcon = document.getElementById('youtube-play-pause-icon');
        const youtubePrevBtn = document.getElementById('youtube-prev-btn');
        const youtubeNextBtn = document.getElementById('youtube-next-btn');

        const playlistContainer = document.getElementById('playlist-container');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResultsContainer = document.getElementById('search-results');
        const youtubeSearchResultsModal = document.getElementById('youtube-search-results-modal'); // Renamed for clarity in modal
        const closeSearchModalBtn = document.getElementById('close-search-modal');
        const searchModal = document.getElementById('search-modal');
        const addSongModal = document.getElementById('add-song-modal');
        const closeAddSongModalBtn = document.getElementById('close-add-song-modal');
        const addSongTitle = document.getElementById('add-song-title');
        const addSongArtist = document.getElementById('add-song-artist');
        const addSongThumbnail = document.getElementById('add-song-thumbnail');
        const confirmAddSongBtn = document.getElementById('confirm-add-song-btn');
        const joinJamModal = document.getElementById('join-jam-modal');
        const closeJoinJamModalBtn = document.getElementById('close-join-jam-modal');
        const createJamModal = document.getElementById('create-jam-modal');
        const closeCreateJamModalBtn = document.getElementById('close-create-jam-modal');
        const createJamButton = document.getElementById('create-jam-button');
        const joinJamButton = document.getElementById('join-jam-button');
        const createJamSessionDropdownBtn = document.getElementById('create-jam-session-dropdown-btn');
        const joinJamSessionDropdownBtn = document.getElementById('join-jam-session-dropdown-btn');
        const joinJamIdInput = document.getElementById('join-jam-id-input'); // Renamed for clarity
        const joinJamNicknameInput = document.getElementById('join-jam-nickname-input');
        const createJamNameInput = document.getElementById('create-jam-name-input');
        const createJamNicknameInput = document.getElementById('create-jam-nickname-input');
        const jamControlsDiv = document.getElementById('jam-controls');
        const jamIdDisplay = document.getElementById('jam-id-display');
        const jamNameDisplay = document.getElementById('jam-name-display');
        const shareJamLinkButton = document.getElementById('share-jam-link-btn');
        const copyJamIdButton = document.getElementById('copy-jam-id-btn');
        const leaveJamButton = document.getElementById('leave-jam-btn');
        const participantsList = document.getElementById('participants-list');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalOkButton = document.getElementById('modal-ok-button');
        const playRandomHostedSongsButton = document.getElementById('play-random-hosted-songs-btn');
        const permissionsManagementDiv = document.getElementById('permissions-management'); // New
        const permissionsList = document.getElementById('permissions-list'); // New

        // Global state
        let playlist = []; // User's local playlist when not in a jam
        let jamSessionPlaylist = []; // Playlist for the current jam session (synced by Socket.IO)
        let currentTrackIndex = 0;
        let isPlaying = false;
        let selectedSongForAdd = null; // Temporarily store song details for add modal
        let youtubePlayer; // YouTube player instance
        let activePlayer = 'local'; // 'local' or 'youtube'
        let currentPlaybackTime = 0; // To store and sync playback time
        let isSeeking = false; // Flag to prevent sync during seeking
        let fullHostedSongsList = []; // Stores the full list of hosted MP3s
        let isLoadingRandomSongs = false; // Prevent multiple clicks on random play
        const INITIAL_RANDOM_QUEUE_SIZE = 10;
        let isPlayingRandomHostedMode = false;


        // Constants
        const BASE_HOSTED_MP3_CDN_URL = "https://vermillion-raindrop-7966d4.netlify.app";

        // --- Utility Functions ---

        /**
         * Displays a modal message to the user.
         * @param {string} message - The message to display.
         * @param {number} duration - How long to display the message in milliseconds (optional).
         */
        function showMessage(message, duration = 3000) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
            if (duration) {
                setTimeout(() => {
                    messageModal.classList.add('hidden');
                }, duration);
            }
        }

        modalOkButton.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        /**
         * Formats time from seconds to MM:SS.
         * @param {number} seconds - Time in seconds.
         * @returns {string} Formatted time string.
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function generateUniqueId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }


        // --- UI Visibility and State Management ---

        /**
         * Updates UI for audio player controls based on active player (local/YouTube).
         * @param {string} playerType - 'local' or 'youtube'.
         */
        function setActivePlayerUI(playerType) {
            if (playerType === 'youtube') {
                localPlayerControls.classList.add('hidden');
                youtubePlayerControls.classList.remove('hidden');
                youtubePlayerDiv.classList.remove('hidden'); // Show YouTube iframe
                songThumbnailImg.classList.add('hidden'); // Hide static thumbnail
                activePlayer = 'youtube';
            } else {
                localPlayerControls.classList.remove('hidden');
                youtubePlayerControls.classList.add('hidden');
                youtubePlayerDiv.classList.add('hidden'); // Hide YouTube iframe
                songThumbnailImg.classList.remove('hidden'); // Show static thumbnail
                activePlayer = 'local';
            }
        }

        /**
         * Resets the player UI to a default state (no song playing).
         */
        function resetPlayerUI() {
            songTitleSpan.textContent = 'No song selected';
            songArtistSpan.textContent = '';
            songThumbnailImg.src = 'https://placehold.co/128x128/CCCCCC/FFFFFF?text=No+Track';
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            youtubePlayPauseIcon.classList.remove('fa-pause');
            youtubePlayPauseIcon.classList.add('fa-play');
            currentTimeSpan.textContent = '0:00';
            durationSpan.textContent = '0:00';
            progressBar.value = 0;
            youtubeCurrentTimeSpan.textContent = '0:00';
            youtubeDurationSpan.textContent = '0:00';
            youtubeProgressBar.value = 0;
            isPlaying = false;
            audioPlayer.pause();
            if (youtubePlayer) {
                youtubePlayer.pauseVideo();
            }
            setActivePlayerUI('local'); // Reset to local player controls by default
        }

        /**
         * Renders the current playlist in the UI.
         */
        function renderPlaylist() {
            const activePlaylist = jamId ? jamSessionPlaylist : playlist;
            playlistContainer.innerHTML = '';
            if (activePlaylist.length === 0) {
                playlistContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Playlist is empty. Add some songs!</p>';
                return;
            }

            activePlaylist.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 ${index === currentTrackIndex && isPlaying ? 'bg-blue-100 dark:bg-blue-800' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                
                // Add disabled styling if not host and in a jam
                if (jamId && socket.id !== currentJamHostSid && !myPermissions.play) {
                    li.classList.add('opacity-70', 'cursor-not-allowed');
                }

                li.innerHTML = `
                    <div class="flex items-center space-x-3 flex-grow">
                        <img src="${song.thumbnail || 'https://placehold.co/40x40/CCCCCC/FFFFFF?text=MP3'}" alt="Thumbnail" class="w-10 h-10 rounded-md object-cover shadow-sm">
                        <div class="flex-grow">
                            <h4 class="text-base font-medium text-gray-800 dark:text-white truncate">${song.title}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${song.artist || song.uploader || 'Unknown Artist'}</p>
                        </div>
                    </div>
                    ${jamId && (socket.id === currentJamHostSid || myPermissions.remove) ? `<button class="remove-song-btn ml-2 p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-800 text-red-600 dark:text-red-300 transition-colors duration-200" data-song-id="${song.id}">
                        <i class="fas fa-times"></i>
                    </button>` : ''}
                `;
                li.addEventListener('click', (event) => {
                    if (jamId && socket.id !== currentJamHostSid && !myPermissions.play) {
                        showMessage("You do not have permission to play songs in this jam.", 3000);
                        return;
                    }
                    if (!event.target.closest('.remove-song-btn')) {
                        playTrack(index);
                    }
                });

                // Add event listener for remove button if in a jam session AND has remove permission
                if (jamId && (socket.id === currentJamHostSid || myPermissions.remove)) {
                    const removeButton = li.querySelector('.remove-song-btn');
                    if (removeButton) {
                        removeButton.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent li click
                            const songId = event.currentTarget.dataset.songId;
                            removeSongFromJam(songId);
                        });
                    }
                }
                playlistContainer.appendChild(li);
            });
            updatePlayerControlPermissions(); // Re-evaluate permissions after rendering
        }

        /**
         * Plays a track from the active playlist by index.
         * @param {number} index - The index of the track to play.
         * @param {number} startTime - Optional start time in seconds.
         */
        async function playTrack(index, startTime = 0) {
            const activePlaylist = jamId ? jamSessionPlaylist : playlist;
            if (index < 0 || index >= activePlaylist.length) {
                resetPlayerUI();
                return;
            }

            // Check permissions before playing
            if (jamId && !myPermissions.play) {
                showMessage("You do not have permission to play songs in this jam.", 3000);
                return;
            }

            const song = activePlaylist[index];
            currentTrackIndex = index;
            isPlaying = true;
            songTitleSpan.textContent = song.title;
            songArtistSpan.textContent = song.artist || song.uploader || 'Unknown Artist';
            songThumbnailImg.src = song.thumbnail || 'https://placehold.co/128x128/CCCCCC/FFFFFF?text=No+Track';
            playPauseIcon.classList.remove('fa-play');
            playPauseIcon.classList.add('fa-pause');
            youtubePlayPauseIcon.classList.remove('fa-play');
            youtubePlayPauseIcon.classList.add('fa-pause');
            progressBar.value = 0;
            youtubeProgressBar.value = 0;

            isPlayingRandomHostedMode = false; // Disable random mode if a specific song is played

            if (song.type === 'youtube') {
                setActivePlayerUI('youtube');
                if (!youtubePlayer) {
                    // Load YouTube IFrame API if not already loaded
                    const tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api";
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                    window.onYouTubeIframeAPIReady = () => {
                        youtubePlayer = new YT.Player('youtube-player', {
                            height: '0', // Hidden
                            width: '0',  // Hidden
                            videoId: song.videoId,
                            playerVars: {
                                'autoplay': 1,
                                'controls': 0, // Hide controls for custom UI
                                'modestbranding': 1,
                                'rel': 0 // Disable related videos
                            },
                            events: {
                                'onReady': (event) => {
                                    event.target.seekTo(startTime);
                                    event.target.playVideo();
                                    updateYouTubeProgressBar();
                                },
                                'onStateChange': onYouTubePlayerStateChange
                            }
                        });
                    };
                } else {
                    youtubePlayer.loadVideoById(song.videoId, startTime);
                    youtubePlayer.playVideo();
                }
            } else {
                setActivePlayerUI('local');
                audioPlayer.src = song.url;
                audioPlayer.currentTime = startTime;
                audioPlayer.play().catch(e => console.error("Error playing audio:", e));
            }
            renderPlaylist(); // Re-render to highlight current song

            // If in a jam, host needs to sync state
            if (jamId && socket.id === currentJamHostSid) {
                updatePlaybackState(true, index, startTime);
            }
        }

        // --- Audio Player Event Handlers (Local MP3s) ---
        audioPlayer.addEventListener('timeupdate', () => {
            if (!isSeeking) {
                progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
                durationSpan.textContent = formatTime(audioPlayer.duration);
            }
        });

        audioPlayer.addEventListener('ended', () => {
            playNextTrack();
        });

        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            playPauseIcon.classList.remove('fa-play');
            playPauseIcon.classList.add('fa-pause');
        });

        audioPlayer.addEventListener('pause', () => {
            isPlaying = false;
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
        });

        audioPlayer.addEventListener('volumechange', () => {
            volumeSlider.value = audioPlayer.volume * 100;
        });

        // --- YouTube Player Event Handlers ---
        function onYouTubePlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                isPlaying = true;
                youtubePlayPauseIcon.classList.remove('fa-play');
                youtubePlayPauseIcon.classList.add('fa-pause');
                updateYouTubeProgressBar(); // Start updating progress bar
            } else {
                isPlaying = false;
                youtubePlayPauseIcon.classList.remove('fa-pause');
                youtubePlayPauseIcon.classList.add('fa-play');
                if (event.data === YT.PlayerState.ENDED) {
                    playNextTrack();
                }
            }
            if (jamId && socket.id === currentJamHostSid) {
                // Host syncs state on play/pause
                updatePlaybackState(isPlaying, currentTrackIndex, youtubePlayer.getCurrentTime());
            }
        }

        function updateYouTubeProgressBar() {
            if (youtubePlayer && isPlaying) {
                if (!isSeeking) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    const duration = youtubePlayer.getDuration();
                    youtubeProgressBar.value = (currentTime / duration) * 100;
                    youtubeCurrentTimeSpan.textContent = formatTime(currentTime);
                    youtubeDurationSpan.textContent = formatTime(duration);
                }
                requestAnimationFrame(updateYouTubeProgressBar);
            }
        }


        // --- Playback Controls ---
        playPauseBtn.addEventListener('click', togglePlayPause);
        youtubePlayPauseBtn.addEventListener('click', togglePlayPause);

        function togglePlayPause() {
            if (!songTitleSpan.textContent || songTitleSpan.textContent === 'No song selected') {
                const activePlaylist = jamId ? jamSessionPlaylist : playlist;
                if (activePlaylist.length > 0) {
                    playTrack(0);
                    return;
                }
                showMessage("No song to play. Add some songs to the playlist.");
                return;
            }

            // Permission check
            if (jamId && !myPermissions.play) {
                showMessage("You do not have permission to control playback in this jam.", 3000);
                return;
            }

            let newIsPlayingState;
            if (activePlayer === 'local') {
                if (isPlaying) {
                    audioPlayer.pause();
                    newIsPlayingState = false;
                } else {
                    audioPlayer.play().catch(e => console.error("Error playing audio:", e));
                    newIsPlayingState = true;
                }
            } else if (activePlayer === 'youtube') {
                if (youtubePlayer) {
                    if (isPlaying) {
                        youtubePlayer.pauseVideo();
                        newIsPlayingState = false;
                    } else {
                        youtubePlayer.playVideo();
                        newIsPlayingState = true;
                    }
                }
            }
            // Host syncs state on play/pause
            if (jamId && socket.id === currentJamHostSid) {
                updatePlaybackState(newIsPlayingState, currentTrackIndex, activePlayer === 'youtube' ? youtubePlayer.getCurrentTime() : audioPlayer.currentTime);
            }
        }

        prevBtn.addEventListener('click', playPrevTrack);
        youtubePrevBtn.addEventListener('click', playPrevTrack);

        function playPrevTrack() {
            const activePlaylist = jamId ? jamSessionPlaylist : playlist;
            if (activePlaylist.length === 0) return;

            // Permission check
            if (jamId && !myPermissions.play) {
                showMessage("You do not have permission to control playback in this jam.", 3000);
                return;
            }

            currentTrackIndex = (currentTrackIndex - 1 + activePlaylist.length) % activePlaylist.length;
            playTrack(currentTrackIndex);
        }

        nextBtn.addEventListener('click', playNextTrack);
        youtubeNextBtn.addEventListener('click', playNextTrack);

        function playNextTrack() {
            const activePlaylist = jamId ? jamSessionPlaylist : playlist;
            if (activePlaylist.length === 0) {
                resetPlayerUI();
                return;
            }
            // Permission check
            if (jamId && !myPermissions.play) {
                showMessage("You do not have permission to control playback in this jam.", 3000);
                return;
            }

            if (isPlayingRandomHostedMode) {
                getUniqueRandomHostedSong(INITIAL_RANDOM_QUEUE_SIZE, true); // Get next random song
            } else {
                currentTrackIndex = (currentTrackIndex + 1) % activePlaylist.length;
                playTrack(currentTrackIndex);
            }
        }

        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            if (activePlayer === 'local') {
                audioPlayer.volume = volume;
            } else if (activePlayer === 'youtube' && youtubePlayer) {
                youtubePlayer.setVolume(volume * 100); // YouTube API uses 0-100
            }
        });

        progressBar.addEventListener('mousedown', () => isSeeking = true);
        progressBar.addEventListener('mouseup', (e) => {
            isSeeking = false;
            // Permission check
            if (jamId && !myPermissions.play) {
                showMessage("You do not have permission to control playback in this jam.", 3000);
                return;
            }
            if (activePlayer === 'local') {
                audioPlayer.currentTime = (e.target.value / 100) * audioPlayer.duration;
            }
            if (jamId && socket.id === currentJamHostSid) {
                updatePlaybackState(isPlaying, currentTrackIndex, audioPlayer.currentTime);
            }
        });
        progressBar.addEventListener('input', (e) => { // Update time display during seek
            if (activePlayer === 'local' && audioPlayer.duration) {
                currentTimeSpan.textContent = formatTime((e.target.value / 100) * audioPlayer.duration);
            }
        });

        youtubeProgressBar.addEventListener('mousedown', () => isSeeking = true);
        youtubeProgressBar.addEventListener('mouseup', (e) => {
            isSeeking = false;
            // Permission check
            if (jamId && !myPermissions.play) {
                showMessage("You do not have permission to control playback in this jam.", 3000);
                return;
            }
            if (activePlayer === 'youtube' && youtubePlayer) {
                const newTime = (e.target.value / 100) * youtubePlayer.getDuration();
                youtubePlayer.seekTo(newTime, true);
                if (jamId && socket.id === currentJamHostSid) {
                    updatePlaybackState(isPlaying, currentTrackIndex, newTime);
                }
            }
        });
        youtubeProgressBar.addEventListener('input', (e) => { // Update time display during seek
            if (activePlayer === 'youtube' && youtubePlayer && youtubePlayer.getDuration()) {
                youtubeCurrentTimeSpan.textContent = formatTime((e.target.value / 100) * youtubePlayer.getDuration());
            }
        });

        // --- Search Functionality ---
        searchButton.addEventListener('click', () => {
            // Permission check for adding songs
            if (jamId && !myPermissions.add) {
                showMessage("You do not have permission to add songs to this jam.", 3000);
                return;
            }
            searchModal.classList.remove('hidden');
        });

        closeSearchModalBtn.addEventListener('click', () => {
            searchModal.classList.add('hidden');
            searchResultsContainer.innerHTML = ''; // Clear previous results
            youtubeSearchResultsModal.innerHTML = ''; // Clear YouTube results
            searchInput.value = ''; // Clear search input
        });

        searchInput.addEventListener('input', debounce(performSearch, 300)); // Debounce search input

        async function performSearch() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                searchResultsContainer.innerHTML = '';
                youtubeSearchResultsModal.innerHTML = '';
                return;
            }

            searchResultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Searching local MP3s...</p>';
            youtubeSearchResultsModal.innerHTML = '<p class="text-gray-500 text-center py-4">Searching YouTube...</p>';

            try {
                // Search hosted MP3s
                const hostedResponse = await fetch(`/search_hosted_mp3s?query=${encodeURIComponent(query)}`);
                const hostedSongs = await hostedResponse.json();
                renderSearchResults(hostedSongs, searchResultsContainer, 'audio');

                // Search YouTube
                const youtubeResponse = await fetch(`/Youtube?query=${encodeURIComponent(query)}`);
                const youtubeVideos = await youtubeResponse.json();
                renderSearchResults(youtubeVideos, youtubeSearchResultsModal, 'youtube');

            } catch (error) {
                console.error("Search error:", error);
                searchResultsContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error searching local MP3s.</p>';
                youtubeSearchResultsModal.innerHTML = '<p class="text-red-500 text-center py-4">Error searching YouTube.</p>';
                showMessage("Failed to perform search. Please try again.");
            }
        }

        function renderSearchResults(results, container, type) {
            container.innerHTML = '';
            if (results.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-4">No ${type} results found.</p>`;
                return;
            }

            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
                div.innerHTML = `
                    <div class="flex items-center space-x-3 flex-grow">
                        <img src="${item.thumbnail || 'https://placehold.co/40x40/CCCCCC/FFFFFF?text=Thumb'}" alt="Thumbnail" class="w-10 h-10 rounded-md object-cover shadow-sm">
                        <div class="flex-grow">
                            <h4 class="text-sm font-medium text-gray-800 dark:text-white truncate">${item.title}</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${item.artist || item.uploader || 'Unknown'}</p>
                        </div>
                    </div>
                    <button class="add-to-playlist-btn ml-2 p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                div.querySelector('.add-to-playlist-btn').addEventListener('click', () => {
                    prepareAddSong(item, type);
                });
                container.appendChild(div);
            });
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function prepareAddSong(song, type) {
            selectedSongForAdd = { ...song, type: type }; // Store selected song with its type
            addSongTitle.textContent = song.title;
            addSongArtist.textContent = song.artist || song.uploader || 'Unknown Artist';
            addSongThumbnail.src = song.thumbnail || 'https://placehold.co/128x128/CCCCCC/FFFFFF?text=No+Image';
            addSongModal.classList.remove('hidden');
        }

        closeAddSongModalBtn.addEventListener('click', () => {
            addSongModal.classList.add('hidden');
            selectedSongForAdd = null;
        });

        confirmAddSongBtn.addEventListener('click', () => {
            if (selectedSongForAdd) {
                addSongToCurrentPlaylist(selectedSongForAdd);
                addSongModal.classList.add('hidden');
                searchModal.classList.add('hidden'); // Close search modal after adding
                searchResultsContainer.innerHTML = '';
                youtubeSearchResultsModal.innerHTML = '';
                searchInput.value = '';
            }
        });

        async function addSongToCurrentPlaylist(song) {
            // Permission check
            if (jamId && !myPermissions.add) {
                showMessage("You do not have permission to add songs to this jam.", 3000);
                return;
            }

            if (jamId) {
                // If in a jam, send to server to add to shared playlist
                if (socket) {
                    socket.emit('add_song_to_jam', { jam_id: jamId, song: song });
                } else {
                    showMessage("Not connected to jam session. Cannot add song.");
                }
            } else {
                // If not in a jam, add to local playlist
                // For YouTube songs, treat as external playback for local playlist
                if (song.type === 'youtube') {
                    const playableSong = {
                        id: song.id, // videoId is the ID
                        title: song.title,
                        artist: song.uploader || song.artist || 'Unknown',
                        thumbnail: song.thumbnail,
                        duration: song.duration,
                        type: 'youtube', // Keep as YouTube type for player logic
                        videoId: song.id // Store videoId for YouTube player
                    };
                    playlist.push(playableSong);
                    showMessage(`Added "${song.title}" to your local playlist.`);
                } else {
                    // For hosted MP3s
                    playlist.push({
                        id: song.id || generateUniqueId(), // Ensure unique ID for local songs too
                        title: song.title,
                        artist: song.artist || 'Unknown',
                        url: song.url,
                        thumbnail: song.thumbnail,
                        duration: song.duration,
                        type: 'audio' // Mark as audio
                    });
                    showMessage(`Added "${song.title}" to your local playlist.`);
                }
            }
            renderPlaylist();
            isPlayingRandomHostedMode = false; // Turn off random mode if user adds a specific song
        }

        function removeSongFromJam(songId) {
            // Permission check
            if (jamId && !myPermissions.remove) {
                showMessage("You do not have permission to remove songs from this jam.", 3000);
                return;
            }
            if (socket) {
                socket.emit('remove_song_from_jam', { jam_id: jamId, song_id: songId });
            } else {
                showMessage("Not connected to jam session.", 3000);
            }
        }

        // --- Jam Session UI Controls ---
        createJamSessionDropdownBtn.addEventListener('click', () => {
            createJamModal.classList.remove('hidden');
        });

        joinJamSessionDropdownBtn.addEventListener('click', () => {
            joinJamModal.classList.remove('hidden');
        });

        closeCreateJamModalBtn.addEventListener('click', () => createJamModal.classList.add('hidden'));
        closeJoinJamModalBtn.addEventListener('click', () => joinJamModal.classList.add('hidden'));

        createJamButton.addEventListener('click', () => {
            const jamName = createJamNameInput.value.trim();
            const nickname = createJamNicknameInput.value.trim() || 'Host';
            if (jamName && socket) {
                socket.emit('create_session', { jam_name: jamName, nickname: nickname });
                createJamModal.classList.add('hidden');
            } else {
                showMessage("Please enter a jam name and ensure you are connected.", 3000);
            }
        });

        joinJamButton.addEventListener('click', () => {
            const enteredJamId = joinJamIdInput.value.trim(); // Use the corrected ID
            const nickname = joinJamNicknameInput.value.trim() || 'Guest';
            if (enteredJamId && socket) {
                socket.emit('join_session', { jam_id: enteredJamId, nickname: nickname });
                joinJamModal.classList.add('hidden');
            } else {
                showMessage("Please enter a Jam ID and ensure you are connected.", 3000);
            }
        });

        shareJamLinkButton.addEventListener('click', () => {
            if (jamId) {
                const shareableLink = `${window.location.origin}/join/${jamId}`;
                
                navigator.clipboard.writeText(shareableLink).then(() => {
                    showMessage("Shareable link copied to clipboard!", 2000);
                }).catch(err => {
                    console.error('Failed to copy text using navigator.clipboard:', err);
                    // Fallback for older browsers / restricted environments
                    const el = document.createElement('textarea');
                    el.value = shareableLink;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showMessage("Shareable link copied to clipboard (fallback)!", 2000);
                });
            } else {
                showMessage("Not in a jam session to share a link.", 3000);
            }
        });

        copyJamIdButton.addEventListener('click', () => {
            if (jamId) {
                navigator.clipboard.writeText(jamId).then(() => {
                    showMessage("Jam ID copied to clipboard!", 2000);
                }).catch(err => {
                    console.error('Failed to copy text using navigator.clipboard:', err);
                    const el = document.createElement('textarea');
                    el.value = jamId;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    showMessage("Jam ID copied to clipboard (fallback)!", 2000);
                });
            } else {
                showMessage("Not in a jam session to copy ID.", 3000);
            }
        });

        leaveJamButton.addEventListener('click', () => {
            if (jamId && socket) {
                if (confirm("Are you sure you want to leave this jam session?")) {
                    socket.emit('disconnect'); // This will trigger server-side disconnect logic and session cleanup
                    // Reset client-side state
                    jamId = null;
                    currentJamHostSid = null;
                    currentJamName = '';
                    myPermissions = { play: false, add: false, remove: false };
                    jamSessionPlaylist = [];
                    jamSessionParticipants = {};
                    resetPlayerUI();
                    renderPlaylist(); // Render local playlist (which will be empty)
                    jamControlsDiv.classList.add('hidden'); // Hide jam controls
                    participantsList.innerHTML = ''; // Clear participants list
                    permissionsManagementDiv.classList.add('hidden'); // Hide permissions management
                    permissionsList.innerHTML = ''; // Clear permissions list
                    showMessage("Left jam session.");
                }
            } else {
                showMessage("You are not currently in a jam session.", 3000);
            }
        });


        // --- Socket.IO Event Listeners ---
        function setupSocketIO() {
            if (socket) {
                socket.disconnect(); // Disconnect existing socket if any
            }
            socket = io(); // Connects to the host that served this page

            socket.on('connect', () => {
                console.log('Socket.IO connected:', socket.id);
                // Check if a jamId was passed from the server (e.g., from /join/<jam_id>)
                const urlParams = new URLSearchParams(window.location.search);
                const initialJamIdFromUrl = urlParams.get('jam_id') || (window.location.pathname.startsWith('/join/') ? window.location.pathname.substring(6) : null); // Check query param or path

                if (initialJamIdFromUrl && initialJamIdFromUrl !== 'null') { // Ensure it's not the string 'null'
                    const nickname = prompt("Enter your nickname to join the jam:");
                    if (nickname) {
                        joinJamIdInput.value = initialJamIdFromUrl; // Pre-fill jam ID
                        joinJamNicknameInput.value = nickname; // Pre-fill nickname
                        // Manually trigger join to allow user to confirm, or directly emit if desired
                        // For now, let user click 'Join Jam' to initiate join_session
                        // socket.emit('join_session', { jam_id: initialJamIdFromUrl, nickname: nickname });
                        openJoinJamModal(); // Open modal with pre-filled info
                    } else {
                        showMessage("Nickname required to join the jam.");
                    }
                    // Clear the URL parameter so refreshing doesn't re-prompt
                    const newUrl = window.location.origin + window.location.pathname.replace(`/join/${initialJamIdFromUrl}`, '');
                    history.replaceState(null, '', newUrl);
                }
            });

            socket.on('disconnect', () => {
                console.log('Socket.IO disconnected.');
                showMessage("Disconnected from server. Jam features may be affected.", 5000);
                jamId = null;
                currentJamHostSid = null;
                currentJamName = '';
                myPermissions = { play: false, add: false, remove: false };
                jamSessionPlaylist = [];
                jamSessionParticipants = {};
                resetPlayerUI();
                renderPlaylist();
                jamControlsDiv.classList.add('hidden');
                permissionsManagementDiv.classList.add('hidden');
                participantsList.innerHTML = '';
                permissionsList.innerHTML = '';
            });

            socket.on('session_created', (data) => {
                jamId = data.jam_id;
                currentJamHostSid = socket.id; // Mark current client as host
                currentJamName = data.jam_name;
                jamSessionPlaylist = data.playlist || []; // Host gets empty playlist
                currentTrackIndex = data.initial_state.current_track_index || 0;
                currentPlaybackTime = data.initial_state.current_playback_time || 0;
                isPlaying = data.initial_state.is_playing || false;
                myPermissions = data.participants[socket.id]?.permissions || { play: false, add: false, remove: false };
                jamSessionParticipants = data.participants; // Full participants data
                
                jamIdDisplay.textContent = `Jam ID: ${jamId}`;
                jamNameDisplay.textContent = `Jam Name: ${currentJamName}`;
                jamControlsDiv.classList.remove('hidden');
                showMessage(`Jam session "${currentJamName}" created! Share ID: ${jamId}`, 5000);

                jamShareLinkInput.value = data.shareable_link;
                shareLinkContainer.classList.remove('hidden');

                renderPlaylist();
                updateParticipantsUI();
                updatePlayerControlPermissions(); // Apply permissions to UI controls
            });

            socket.on('session_join_success', (data) => {
                jamId = data.jam_id;
                currentJamHostSid = data.host_sid; // Get host SID from received data
                currentJamName = data.jam_name;
                jamSessionPlaylist = data.playlist || [];
                currentTrackIndex = data.current_track_index || 0;
                currentPlaybackTime = data.current_playback_time || 0;
                isPlaying = data.is_playing || false;
                myPermissions = data.participants[socket.id]?.permissions || { play: false, add: false, remove: false };
                jamSessionParticipants = data.participants; // Full participants data
                
                jamIdDisplay.textContent = `Jam ID: ${jamId}`;
                jamNameDisplay.textContent = `Jam Name: ${currentJamName}`;
                jamControlsDiv.classList.remove('hidden');
                showMessage(`Joined jam session "${currentJamName}". Welcome, ${data.nickname_used || 'Guest'}!`, 5000);

                // Play current track if host is playing
                if (isPlaying && jamSessionPlaylist.length > 0) {
                    // Calculate synchronized time based on last synced timestamp
                    const timeDiff = (Date.now() / 1000) - (data.last_synced_at || 0);
                    let syncedTime = (currentPlaybackTime || 0) + timeDiff;
                    
                    // Ensure syncedTime doesn't exceed duration
                    const currentSong = jamSessionPlaylist[currentTrackIndex];
                    if (currentSong && currentSong.duration && syncedTime > currentSong.duration) {
                        syncedTime = 0;
                    }
                    playTrack(currentTrackIndex, syncedTime);
                } else {
                    resetPlayerUI();
                }
                
                renderPlaylist();
                updateParticipantsUI();
                updatePlayerControlPermissions(); // Apply permissions to UI controls
            });

            // Listener for when host updates playback state (play/pause/seek/track change)
            socket.on('playback_state_updated', (data) => {
                if (data.jam_id === jamId && socket.id !== currentJamHostSid) { // Only followers update from this
                    const newPlaybackState = data.playback_state || {};
                    const newPlaylist = data.playlist || [];

                    const serverTrackIndex = newPlaybackState.current_track_index || 0;
                    const serverPlaybackTime = newPlaybackState.current_playback_time || 0;
                    const serverIsPlaying = newPlaybackState.is_playing || false;
                    const serverTimestamp = newPlaybackState.timestamp || 0;

                    // Update playlist if changed
                    if (JSON.stringify(jamSessionPlaylist) !== JSON.stringify(newPlaylist)) {
                        jamSessionPlaylist = newPlaylist;
                        renderPlaylist();
                    }

                    // Calculate synchronized time based on timestamp
                    const timeDiff = (Date.now() / 1000) - serverTimestamp;
                    let syncedTime = serverPlaybackTime + timeDiff;

                    const currentSong = jamSessionPlaylist[serverTrackIndex];
                    if (currentSong && currentSong.duration && syncedTime > currentSong.duration) {
                        syncedTime = 0;
                    }

                    // Only update if there's a significant change
                    if (currentTrackIndex !== serverTrackIndex || isPlaying !== serverIsPlaying || Math.abs(currentPlaybackTime - syncedTime) > 1.5) {
                        currentTrackIndex = serverTrackIndex;
                        currentPlaybackTime = syncedTime;
                        isPlaying = serverIsPlaying;

                        if (isPlaying && jamSessionPlaylist.length > 0) {
                            playTrack(currentTrackIndex, currentPlaybackTime);
                        } else {
                            if (activePlayer === 'local') {
                                audioPlayer.pause();
                                audioPlayer.currentTime = currentPlaybackTime;
                            } else if (activePlayer === 'youtube' && youtubePlayer) {
                                youtubePlayer.pauseVideo();
                                youtubePlayer.seekTo(currentPlaybackTime, true);
                            }
                            resetPlayerUI(); // Just reset if not playing
                            renderPlaylist(); // Update highlighting
                        }
                        console.log(`Follower synced: Index ${currentTrackIndex}, Time ${formatTime(currentPlaybackTime)}, Playing: ${isPlaying}`);
                    }
                }
            });

            // Listener for when playlist changes (add/remove song by host)
            socket.on('playlist_updated', (data) => {
                if (data.jam_id === jamId) {
                    jamSessionPlaylist = data.playlist || [];
                    renderPlaylist();
                    // Playback state is handled by playback_state_updated for consistency
                }
            });


            socket.on('session_ended', (data) => {
                showMessage(`Jam session "${data.jam_id}" has ended: ${data.message}`, 5000);
                jamId = null;
                currentJamHostSid = null;
                currentJamName = '';
                myPermissions = { play: false, add: false, remove: false };
                jamSessionPlaylist = [];
                jamSessionParticipants = {};
                resetPlayerUI();
                renderPlaylist();
                jamControlsDiv.classList.add('hidden');
                permissionsManagementDiv.classList.add('hidden');
                participantsList.innerHTML = '';
                permissionsList.innerHTML = '';
            });

            socket.on('update_participants', (data) => {
                if (data.jam_id === jamId) {
                    jamSessionParticipants = data.participants; // Full participants object
                    myPermissions = jamSessionParticipants[socket.id]?.permissions || { play: false, add: false, remove: false };
                    updateParticipantsUI();
                    updatePlayerControlPermissions(); // Re-apply permissions
                }
            });

            socket.on('join_failed', (data) => {
                console.error("Jam join failed:", data.message);
                showMessage(`Failed to join jam: ${data.message}`);
                jamId = null;
                currentJamHostSid = null;
                currentJamName = '';
                myPermissions = { play: false, add: false, remove: false };
                jamSessionPlaylist = [];
                jamSessionParticipants = {};
                resetPlayerUI();
                renderPlaylist();
                jamControlsDiv.classList.add('hidden');
                permissionsManagementDiv.classList.add('hidden');
                participantsList.innerHTML = '';
                permissionsList.innerHTML = '';
            });

            socket.on('permission_denied', (data) => {
                console.warn(`Permission denied for action: ${data.action} - ${data.message}`);
                showMessage(`Permission Denied: ${data.message}`, 4000);
            });
        }


        // Host only: sends playback state to server
        function updatePlaybackState(isPlayingOverride = null, trackIndexOverride = null, playbackTimeOverride = null) {
            if (!jamId || socket.id !== currentJamHostSid || !socket) {
                return; // Only host can update, and only if in a jam and socket is ready
            }

            const activePlaylist = jamId ? jamSessionPlaylist : playlist; // Host manages its local playlist
            const currentTrack = activePlaylist[currentTrackIndex]; // Get current track from client's active playlist
            if (!currentTrack) return;

            let currentTime = playbackTimeOverride !== null ? playbackTimeOverride : 0;
            let isPlaying = isPlayingOverride !== null ? isPlayingOverride : false;
            let trackIndex = trackIndexOverride !== null ? trackIndexOverride : currentTrackIndex;

            if (activePlayer === 'local') {
                currentTime = playbackTimeOverride !== null ? playbackTimeOverride : audioPlayer.currentTime;
                isPlaying = isPlayingOverride !== null ? isPlayingOverride : !audioPlayer.paused;
            } else if (activePlayer === 'youtube' && youtubePlayer) {
                currentTime = playbackTimeOverride !== null ? playbackTimeOverride : youtubePlayer.getCurrentTime();
                isPlaying = isPlayingOverride !== null ? isPlayingOverride : (youtubePlayer.getPlayerState() === YT.PlayerState.PLAYING);
            }
            // If the current action is related to playing, ensure current playback time is recent
            if (isPlayingOverride !== null || playbackTimeOverride !== null || trackIndexOverride !== null) {
                 socket.emit('sync_playback_state', {
                    jam_id: jamId,
                    current_track_index: trackIndex,
                    current_playback_time: currentTime,
                    is_playing: isPlaying,
                    playlist: activePlaylist // Host sends full playlist with every sync
                });
                console.log(`Host synced state to server: Index ${trackIndex}, Time ${formatTime(currentTime)}, Playing: ${isPlaying}`);
            }
        }

        // --- Participant List UI & Permissions ---
        function updateParticipantsUI() {
            participantsList.innerHTML = '';
            permissionsList.innerHTML = ''; // Clear permissions list each time

            const participantEntries = Object.entries(jamSessionParticipants); // Get [sid, {data}] pairs

            participantEntries.forEach(([sid, data]) => {
                const isMe = (sid === socket.id);
                const isHost = (sid === currentJamHostSid);
                const nickname = data.nickname || 'Unknown';
                const permissions = data.permissions || { play: false, add: false, remove: false };

                // Display participant in general list
                const participantLi = document.createElement('li');
                participantLi.className = 'py-1 text-gray-700 dark:text-gray-300';
                participantLi.textContent = `${nickname} ${isMe ? '(You)' : ''} ${isHost ? '(Host)' : ''}`;
                participantsList.appendChild(participantLi);

                // If current client is the host, render permission controls for others
                if (socket.id === currentJamHostSid && !isMe) { // Host can manage others' permissions
                    const permissionItem = document.createElement('div');
                    permissionItem.className = 'flex items-center space-x-2 bg-gray-100 p-2 rounded-md mb-1';
                    permissionItem.innerHTML = `
                        <span class="font-medium text-gray-800 flex-shrink-0 w-24 truncate">${nickname}</span>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" data-permission="play" data-sid="${sid}" ${permissions.play ? 'checked' : ''}>
                            <span class="ml-1 text-sm text-gray-700">Play</span>
                        </label>
                        <label class="inline-flex items-center ml-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-green-600" data-permission="add" data-sid="${sid}" ${permissions.add ? 'checked' : ''}>
                            <span class="ml-1 text-sm text-gray-700">Add</span>
                        </label>
                        <label class="inline-flex items-center ml-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-red-600" data-permission="remove" data-sid="${sid}" ${permissions.remove ? 'checked' : ''}>
                            <span class="ml-1 text-sm text-gray-700">Remove</span>
                        </label>
                    `;
                    permissionsList.appendChild(permissionItem);

                    // Add event listeners for permission checkboxes
                    permissionItem.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', (event) => {
                            const targetSid = event.target.dataset.sid;
                            const permissionType = event.target.dataset.permission;
                            const isChecked = event.target.checked;
                            const updatedPerms = { [permissionType]: isChecked };
                            socket.emit('update_participant_permissions', {
                                jam_id: jamId,
                                target_sid: targetSid,
                                permissions: updatedPerms
                            });
                        });
                    });
                }
            });

            // Show/hide permissions management section based on host status
            if (socket.id === currentJamHostSid) {
                permissionsManagementDiv.classList.remove('hidden');
            } else {
                permissionsManagementDiv.classList.add('hidden');
            }

            // Update the count
            document.getElementById('participants-count').textContent = `Participants (${participantEntries.length}):`;
        }

        // Function to enable/disable UI controls based on myPermissions
        function updatePlayerControlPermissions() {
            const isHost = (socket.id === currentJamHostSid);

            // Playback controls (play/pause, prev, next, progress bar)
            const playbackControls = [playPauseBtn, prevBtn, nextBtn, progressBar, youtubePlayPauseBtn, youtubePrevBtn, youtubeNextBtn, youtubeProgressBar];
            playbackControls.forEach(btn => {
                if (btn) {
                    btn.disabled = !(isHost || myPermissions.play);
                    if (btn.disabled) btn.classList.add('opacity-70', 'cursor-not-allowed');
                    else btn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            });
            // Volume slider is always enabled (local control)
            volumeSlider.disabled = false;
            volumeSlider.classList.remove('opacity-70', 'cursor-not-allowed');
            youtubeVolumeSlider.disabled = false;
            youtubeVolumeSlider.classList.remove('opacity-70', 'cursor-not-allowed');

            // Add Songs Button & Search Modal Trigger
            searchButton.disabled = !(isHost || myPermissions.add);
            if (searchButton.disabled) searchButton.classList.add('opacity-70', 'cursor-not-allowed');
            else searchButton.classList.remove('opacity-70', 'cursor-not-allowed');

            // Random Hosted Songs button
            playRandomHostedSongsButton.disabled = !(isHost || myPermissions.add); // Assuming adding songs to playlist is required for random
            if (playRandomHostedSongsButton.disabled) playRandomHostedSongsButton.classList.add('opacity-70', 'cursor-not-allowed');
            else playRandomHostedSongsButton.classList.remove('opacity-70', 'cursor-not-allowed');


            // Playlist items' clickability (for playing)
            playlistContainer.querySelectorAll('li').forEach(li => {
                if (isHost || myPermissions.play) {
                    li.classList.remove('opacity-70', 'cursor-not-allowed');
                } else {
                    li.classList.add('opacity-70', 'cursor-not-allowed');
                }
            });

            // Playlist items' remove buttons (rendered dynamically, but re-evaluate)
            renderPlaylist(); // Rerender playlist to update remove buttons correctly
        }

        // --- Play Random Hosted Songs ---
        playRandomHostedSongsButton.addEventListener('click', async () => {
            // Permission check
            if (jamId && !myPermissions.add) { // Assuming random play adds to playlist, so needs 'add' perm
                showMessage("You do not have permission to play random songs in this jam.", 3000);
                return;
            }

            if (isLoadingRandomSongs) {
                showMessage("Generating random playlist. Please wait...", 2000);
                return;
            }
            // Logic for playing random hosted songs outside a jam session is removed
            // as this feature is primarily for host to manage jam playlist.
            // If the user wants this outside a jam, it implies local state, which doesn't need permissions.
            // For now, I'm keeping it only for jam host/add permission
            if (!jamId || socket.id !== currentJamHostSid) { // This should ideally be handled by permissions check above
                showMessage("Only the host can start random playback in a Jam Session.", 3000);
                return;
            }

            isLoadingRandomSongs = true;
            playRandomHostedSongsButton.disabled = true;
            playRandomHostedSongsButton.classList.add('opacity-50', 'cursor-not-allowed');
            showMessage("Generating random playlist, please wait...");

            try {
                if (fullHostedSongsList.length === 0) {
                    const response = await fetch('/hosted_songs_manifest.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    fullHostedSongsList = await response.json();
                    if (fullHostedSongsList.length === 0) {
                        showMessage("No hosted MP3s found. Cannot generate random playlist.", 4000);
                        isLoadingRandomSongs = false;
                        playRandomHostedSongsButton.disabled = false;
                        playRandomHostedSongsButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        return;
                    }
                }

                jamSessionPlaylist = []; // Clear current jam playlist
                isPlayingRandomHostedMode = true;
                getUniqueRandomHostedSong(INITIAL_RANDOM_QUEUE_SIZE);
                currentTrackIndex = 0;
                if (jamSessionPlaylist.length > 0) {
                    // Host initiates playback and updates state
                    updatePlaybackState(true, 0, 0); // Force playing the first random track
                    showMessage(`Generated a random playlist of ${jamSessionPlaylist.length} songs!`, 3000);
                } else {
                    showMessage("Could not generate a random playlist. Try again.", 3000);
                }

            } catch (error) {
                console.error("Error generating random playlist:", error);
                showMessage("Failed to generate random playlist. See console for details.", 5000);
            } finally {
                isLoadingRandomSongs = false;
                playRandomHostedSongsButton.disabled = false;
                playRandomHostedSongsButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        function getUniqueRandomHostedSong(count, addToExisting = false) {
            const availableSongs = fullHostedSongsList.filter(s => !jamSessionPlaylist.some(p => p.id === s.id));
            if (availableSongs.length === 0) {
                if (jamSessionPlaylist.length > 0) {
                    jamSessionPlaylist = []; // Clear for fresh random selection
                    showMessage("All available unique songs were played. Restarting random queue.", 3000);
                    getUniqueRandomHostedSong(INITIAL_RANDOM_QUEUE_SIZE); // Recursively call for a new set
                    return;
                } else {
                    showMessage("No unique random songs available from the manifest.", 3000);
                    isPlayingRandomHostedMode = false;
                    return;
                }
            }

            const songsToAdd = [];
            for (let i = 0; i < count && availableSongs.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * availableSongs.length);
                songsToAdd.push(availableSongs.splice(randomIndex, 1)[0]);
            }

            if (addToExisting) {
                jamSessionPlaylist.push(...songsToAdd);
            } else {
                jamSessionPlaylist = songsToAdd;
            }
            renderPlaylist();
        }

        // --- Initial Load Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup Socket.IO immediately
            setupSocketIO();
            loadYouTubeAPI(); // Load YouTube IFrame API

            // Initial UI setup
            resetPlayerUI();
            renderPlaylist(); // Render empty local playlist initially
            updatePlayerControlPermissions(); // Set initial permissions (all enabled if not in jam)

            // Check URL for jam_id on page load, pre-fill join modal if present
            const urlParams = new URLSearchParams(window.location.search);
            const urlJamId = urlParams.get('jam_id') || (window.location.pathname.startsWith('/join/') ? window.location.pathname.substring(6) : null);
            
            if (urlJamId) {
                joinJamIdInput.value = urlJamId; // Pre-fill the input
                // We'll let the user manually click the Join Jam button to initiate the join
                // since we want them to enter a nickname.
                joinJamModal.classList.remove('hidden'); // Show the modal
            } else {
                showMessage("Welcome! Create or join a Jam Session.", 3000);
            }
        });
    </script>
</body>
</html>
